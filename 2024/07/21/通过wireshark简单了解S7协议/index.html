

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="xiao cuncun">
  <meta name="keywords" content="blog">
  
    <meta name="description" content="一方面本着学习wireshark的使用，一方面对S7协议想有一个更深入一点的了解。 1.建立连接过程：一边是IPC，一边是PLC。本着学习的态度，这里简单说明一下S7通信协议簇在ISO模型中的一个示意：    OSI layers Protocol    7 APPlication Layer S7 communication   6 Presentation Layer COTP(S7 comm">
<meta property="og:type" content="article">
<meta property="og:title" content="通过wireshark简单了解S7协议">
<meta property="og:url" content="http://example.com/2024/07/21/%E9%80%9A%E8%BF%87wireshark%E7%AE%80%E5%8D%95%E4%BA%86%E8%A7%A3S7%E5%8D%8F%E8%AE%AE/index.html">
<meta property="og:site_name" content="Whatsxiaocuncun Personal website">
<meta property="og:description" content="一方面本着学习wireshark的使用，一方面对S7协议想有一个更深入一点的了解。 1.建立连接过程：一边是IPC，一边是PLC。本着学习的态度，这里简单说明一下S7通信协议簇在ISO模型中的一个示意：    OSI layers Protocol    7 APPlication Layer S7 communication   6 Presentation Layer COTP(S7 comm">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412203740658-1056837989.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412210730787-1943484678.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412213821395-254230614.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412214359568-2083149726.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412223632243-27706838.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412225113494-311462876.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412235712473-299747324.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240412233505015-647695466.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413000414793-1524140916.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413001502091-1272970033.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413001533101-1499371587.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413002349198-666858195.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413002403731-1772660387.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413003227257-169259647.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413003821245-1166548826.png">
<meta property="og:image" content="http://example.com/img/blog_page/3427087-20240413004638155-1196505560.png">
<meta property="article:published_time" content="2024-07-21T06:44:39.319Z">
<meta property="article:modified_time" content="2024-07-21T09:36:45.034Z">
<meta property="article:author" content="xiao cuncun">
<meta property="article:tag" content="S7">
<meta property="article:tag" content="PN">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/blog_page/3427087-20240412203740658-1056837989.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>通过wireshark简单了解S7协议 - Whatsxiaocuncun Personal website</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>一位不愿透露姓名的小村村同学的个人博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="通过wireshark简单了解S7协议"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-07-21 14:44" pubdate>
          2024年7月21日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          19 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">通过wireshark简单了解S7协议</h1>
            
            
              <div class="markdown-body">
                
                <p>一方面本着学习wireshark的使用，一方面对S7协议想有一个更深入一点的了解。</p>
<h2 id="1-建立连接过程："><a href="#1-建立连接过程：" class="headerlink" title="1.建立连接过程："></a>1.建立连接过程：</h2><p><img src="/img/blog_page/3427087-20240412203740658-1056837989.png" srcset="/img/loading.gif" lazyload alt="re"><br>一边是IPC，一边是PLC。<br>本着学习的态度，这里简单说明一下S7通信协议簇在ISO模型中的一个示意：</p>
<table>
<thead>
<tr>
<th>OSI layers</th>
<th>Protocol</th>
</tr>
</thead>
<tbody><tr>
<td>7 APPlication Layer</td>
<td>S7 communication</td>
</tr>
<tr>
<td>6 Presentation Layer</td>
<td>COTP(S7 communication)</td>
</tr>
<tr>
<td>5 Session Layer</td>
<td>TPKT(S7 communication)</td>
</tr>
<tr>
<td>4 Transport Layer</td>
<td>ISO-on-TCP</td>
</tr>
<tr>
<td>3 Network Layer</td>
<td>IP</td>
</tr>
<tr>
<td>2 Data Link Layer</td>
<td>Ethernet</td>
</tr>
<tr>
<td>1 Physical Layer</td>
<td>Ethernet</td>
</tr>
</tbody></table>
<p>第1-4层是由计算机自己完成的（底层驱动）。<br>现在从Frame2-Frame4开始逐帧分析：</p>
<ul>
<li><p>物理层数据帧:<br><img src="/img/blog_page/3427087-20240412210730787-1943484678.png" srcset="/img/loading.gif" lazyload><br>这一行给出了物理层信息，其中没有中括号的是数据报文本身提取的一些信息，带有中括号的是根据报文整体的分析给出的辅助信息，虽然报文本身并不包含这些字段信息。</p>
<blockquote>
<p>.Frame 2: 66 bytes on wire (528 bits), 66 bytes captured (528bits)   2号帧，线路66字节，实际捕获528bits<br>.Encapsulation type: Ethernet (1) #封装类型，表示以太网的链路<br>.Arrival Time:  捕获日期和时间（中国标准时间）<br>.[Time shift for this packet: 0.000000000 seconds]<br>.Epoch Time: 绝对时间秒数（和前一种是不同的表达方式）<br>.[Time delta from previous captured frame: xx seconds]    此包与前一包时间间隔<br>.[Time delta from previous displayed frame: xx seconds]<br>.[Time since reference or first frame: xx seconds]    此包与第一个帧的时间间隔<br>.Frame Number: 2   帧序号<br>.Frame Length: 66 bytes (528 bits)    帧长度，数据的长度，是根据协议这种类格式中length所得到的长度，和后面的Capture Length长度是不同的。<br>.Capture Length: 66 bytes (528 bits)    在网卡上实际捕获的数据帧长度。通常情况下Frame Length和Capture Length 是相同的，但是如果Capture Length所捕获的数据有缺失，则Capture Length要比Frame Length要小一些。<br>.[Frame is marked: False]     此帧是否做了标记：否<br>.[Frame is ignored: False]<br>.[Protocols in frame: eth:ethertype:ip:tcp]   帧内封装的协议层次结构<br>.[Coloring Rule Name: HTTP]   用不同颜色的染色标记的协议名称：HTTP<br>.[Coloring Rule String: http || tcp.port &#x3D;&#x3D; 80 || http2]    染色显示规则字符串</p>
</blockquote>
</li>
<li><p>Transmisssion control protocol<br><img src="/img/blog_page/3427087-20240412213821395-254230614.png" srcset="/img/loading.gif" lazyload></p>
</li>
</ul>
<p>这一行描述的传输控制协议,这里主要做一下名词解释</p>
<blockquote>
<p>.Source port:源端口51664<br>.Destination port:目的端口102<br>.Flags:0x002(SYN):表示表示建立连接。拓展一下，FIN表示关闭连接，ACK表示响应，PSH表示由DATA数据传输，RST表示连接重置。</p>
</blockquote>
<ul>
<li>TCP connect<br><img src="/img/blog_page/3427087-20240412214359568-2083149726.png" srcset="/img/loading.gif" lazyload><br>这三行，注意右边的info,他们表示经典的了TCP的三次握手过程。<blockquote>
<p>.Seq为序号，等下描述握手的时候会再讲到它<br>.Ack为确认号，也是个重要参数<br>.Win&#x3D;64240表示窗口大小，理解为允许对方发送的最大数据量<br>.Len&#x3D;0表示TCP数据部分长度<br>.MSS&#x3D;1460表示最大报文长度<br>.WS&#x3D;256表示窗口的放大倍数<br>.SACK_PERM表示通信双方均支持SACK机制</p>
</blockquote>
</li>
</ul>
<p>TCP采用三次握手来建立一个连接，其过程如下：<br><code>第一次握手：主机A发送标志位SYN=1，主机B由SYN状态知道A要求建立连接,当前主机A的Sequence number=0，Acknowledgment number=0</code><br><code>第二次握手：主机B收到请求后，Sequence number=0，Acknowledgment number=1，主机B的SYN=1,ACK=1</code><br><code>第三次握手：主机A检查Acknowledgment number=1是否正确，以及ACK=1是否正确。主机B收到Seq值和Ack=1时表示连接建立成功</code><br><code>完成三次握手，主机A和主机B开始传数据</code></p>
<h2 id="2-COTP协议"><a href="#2-COTP协议" class="headerlink" title="2. COTP协议"></a>2. COTP协议</h2><p>COTP协议的全称是connection-Oriented Transport Protocol,面向连接的传输协议。顾名思义，他必然是依赖连接的，所以在传输之前必然要先有类似TCP握手建立连接的过程的。<br>这里还是直接截图逐帧分析，概念光说太抽象：<br><img src="/img/blog_page/3427087-20240412223632243-27706838.png" srcset="/img/loading.gif" lazyload><br>注意看，两个COTP包里面，wireshark已经为我们标注出CR和CC，其实这里的CR就是connect request,CC就是connect confirm。一个表示请求连接，一个表示确认连接。这就是一个建立连接的过程。<br>其实在建立连接之后，还跟一个DT包，这个就是DATA的意思，表示在发送数据。<br>对于COTP而已，它的包有两种形态，叫做COTP连接包（COTP connection package）和COTP功能包(COTP function package)。<br>先来看看COTP连接包的几个关键参数：<br><img src="/img/blog_page/3427087-20240412225113494-311462876.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>.Length:数据的长度，不包括length这个字段本身（和profinet里面定义字段长度的风格一样）<br>.PDU type:这里是标志类型，0x0e就表示连接请求，我会在后面把PDU的常见类型码例举出来。<br>.Destination reference:目标的引用，可以认为是用来唯一标志目标的<br>.Source reference:源的引用，可以认为是用来唯一标志目标的<br>.Option:占用1byte,高4位是标志类别class,倒数第二位是拓展样式，倒数第一位表示是否有明确的指定流控制。<br>.Parameter:附加的参数字段，每个参数又有几个字段构成。字段code&#x3D;0xC0表示tpdu-size，就是数传数据的大小；code&#x3D;0xC1表示src-tsap；code&#x3D;0xC2表示dst-tsap<br>.TSAP:一般在西门子里面，TSAP表示的是连接资源的地址，有两个，一个是Local tsap，表示采集程序的地址，一个是Remote tsap,大概相当于PLC的地址。所以从这个解释来看，code的tsap参数可能是表示的源和目标的地址。</p>
</blockquote>
<p>对于COTP功能包而已，其实好像没啥看的，具体也就那么些东西：<br><img src="/img/blog_page/3427087-20240412235712473-299747324.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>.length:长度<br>.PDU type:标志类型<br>.Option:第一位标志是否是最后一个包（从这看出来COPT协议当数据较多的时候会拆开来做单元传输），后面7个位表示的是TPDU的number.</p>
</blockquote>
<p>现在开始分别贴一下COTP连接包和功能包的PDU TYPE吧：</p>
<ul>
<li>COTP连接包</li>
</ul>
<table>
<thead>
<tr>
<th>Code</th>
<th>info</th>
</tr>
</thead>
<tbody><tr>
<td>0x1</td>
<td>ED Expedited data,加急数据</td>
</tr>
<tr>
<td>0x2</td>
<td>EA Expedited data acknowledgement,加急数据确认</td>
</tr>
<tr>
<td>0x4</td>
<td>UD,用户数据</td>
</tr>
<tr>
<td>0x5</td>
<td>RJ Reject,拒绝</td>
</tr>
<tr>
<td>0x6</td>
<td>AK Data acknowledgement,数据确认</td>
</tr>
<tr>
<td>0x7</td>
<td>ER TPDU Error,TPDU错误</td>
</tr>
<tr>
<td>0x8</td>
<td>DR Disconnect Request,断开请求</td>
</tr>
<tr>
<td>0xC</td>
<td>DC Disconnect Confirm,断开确认</td>
</tr>
<tr>
<td>0xD</td>
<td>CC Connect Confirm,连接确认</td>
</tr>
<tr>
<td>0xE</td>
<td>CR Connect Request,连接请求</td>
</tr>
<tr>
<td>0xF</td>
<td>DT data,数据传输</td>
</tr>
</tbody></table>
<ul>
<li>COTP功能包（其实和上面是一样的）</li>
</ul>
<table>
<thead>
<tr>
<th>Code</th>
<th>info</th>
</tr>
</thead>
<tbody><tr>
<td>0x1</td>
<td>ED Expedited data,加急数据</td>
</tr>
<tr>
<td>0x2</td>
<td>EA Expedited data acknowledgement,加急数据确认</td>
</tr>
<tr>
<td>0x4</td>
<td>UD,用户数据</td>
</tr>
<tr>
<td>0x5</td>
<td>RJ Reject,拒绝</td>
</tr>
<tr>
<td>0x6</td>
<td>AK Data acknowledgement,数据确认</td>
</tr>
<tr>
<td>0x7</td>
<td>ER TPDU Error,TPDU错误</td>
</tr>
<tr>
<td>0x8</td>
<td>DR Disconnect Request,断开请求</td>
</tr>
<tr>
<td>0xC</td>
<td>DC Disconnect Confirm,断开确认</td>
</tr>
<tr>
<td>0xD</td>
<td>CC Connect Confirm,连接确认</td>
</tr>
<tr>
<td>0xE</td>
<td>CR Connect Request,连接请求</td>
</tr>
<tr>
<td>0xF</td>
<td>DT data,数据传输</td>
</tr>
</tbody></table>
<h2 id="3-TPKT协议"><a href="#3-TPKT协议" class="headerlink" title="3. TPKT协议"></a>3. TPKT协议</h2><p>TPKT叫做transport service ontop of the TCP。顾名思义，就是在TCP之上的传输服务，它是为了在TCP和COTP之间建立桥梁的。其实在讲COTP之前应该先讲TPKT的。<br>TPKT一般和COTP一起发送，当作COTP的header段。<br>下面贴个图，这个结构很简单没什么好讲的：<br><img src="/img/blog_page/3427087-20240412233505015-647695466.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>.version:版本号<br>.reserved:保留<br>.length:总长度</p>
</blockquote>
<h2 id="4-S7-communication协议"><a href="#4-S7-communication协议" class="headerlink" title="4. S7 communication协议"></a>4. S7 communication协议</h2><p>终于讲到S7COMN了，这对于我来说是个很神奇的黑科技。因为我就是通过它直接读到了PLC数据的绝对地址。<br>S7COMM协议包含3个部分：</p>
<ul>
<li>Header</li>
<li>Parameter</li>
<li>Data</li>
</ul>
<p>先讲Header,格式如下：</p>
<table>
<thead>
<tr>
<th>Protocol ID</th>
<th>PDU TYPE</th>
<th>reserved</th>
<th>PDU reference</th>
<th>param length</th>
<th>data length</th>
<th>error class</th>
<th>error code</th>
</tr>
</thead>
</table>
<p>贴图如下，逐一解释：<br><img src="/img/blog_page/3427087-20240413000414793-1524140916.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>.Protocol ID:协议ID，通常就是0x32<br>.ROSCTR:常用的几个：&#x3D;0x01,表示JOB，作业请求；&#x3D;0x02,表示ACK，确认响应；&#x3D;0x03,表示ACK_DATA，确认数据响应；&#x3D;0x07,表示USERDATA，原始协议的拓展（像啥安全功能，时间设置，循环读取..）；<br>.Redundancy identification(reserved):冗余数据，通常就是0x0000<br>.Protocol data unit reference:协议数据单元参考，通过请求时间增加<br>.param length:参数长度<br>.data length:数据长度，如果是PLC内部数据就是0x0000,对于其他功能，就是Data部分的长度。</p>
</blockquote>
<p>其中最重要的就是ROSCTR,它决定了后续参数的结构。<br>比如在Job中的结构：<br><img src="/img/blog_page/3427087-20240413001502091-1272970033.png" srcset="/img/loading.gif" lazyload><br>又比如在ACK_Data中的结构：<br><img src="/img/blog_page/3427087-20240413001533101-1499371587.png" srcset="/img/loading.gif" lazyload><br>你看出区别来了吗？</p>
<p>继续讲Parameter，这个比较复杂多变。在PDU类型是Job和ACK时格式如下：</p>
<table>
<thead>
<tr>
<th>function code</th>
<th>reserved</th>
<th>Max AmQ calling</th>
<th>Max AmQ called</th>
<th>PDU length</th>
</tr>
</thead>
</table>
<p>job：<br><img src="/img/blog_page/3427087-20240413002349198-666858195.png" srcset="/img/loading.gif" lazyload><br>ack_data：<br><img src="/img/blog_page/3427087-20240413002403731-1772660387.png" srcset="/img/loading.gif" lazyload></p>
<p>当PDU类型是Job时参数为Read Var[0x40]格式如下:</p>
<table>
<thead>
<tr>
<th>function</th>
<th>item count</th>
<th>item 1</th>
<th>…</th>
<th>item n</th>
</tr>
</thead>
</table>
<p>其中item的格式又如下：</p>
<table>
<thead>
<tr>
<th>specification type</th>
<th>length</th>
<th>syntax ID</th>
<th>transport sizes</th>
<th>request data length</th>
<th>DB number</th>
<th>Area</th>
<th>Adderss</th>
</tr>
</thead>
</table>
<p>还是截图说吧，看格式有点抽象：<br><img src="/img/blog_page/3427087-20240413003227257-169259647.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>.Variable specification:确定项目结构的主要类型，通常就是0x12<br>.Length of following address specification，本Item其余部分的长度<br>.Syntax Ids of variable specification，确定寻址模式和其余项目结构的格式<br>.Transport sizes in item data，确定变量的类型和长度<br>.Request data length，请求的数据长度<br>. DB number，DB模块的编号，如果访问的不是DB区域，此处为0x0000<br>.Area，区域类型</p>
</blockquote>
<p>上面说的是当PDU为Job时，S7COMMN的结构，那当PDU为ACK_DATA时结构又是怎么样的呢？我们不说虚的，直接截图：<br><img src="/img/blog_page/3427087-20240413003821245-1166548826.png" srcset="/img/loading.gif" lazyload><br>是的，其Parameter只有function、item count两个字段。<br>继续，那么接下来的是Data啦！</p>
<blockquote>
<p>.Return code，返回代码<br>.Transport size，数据的传输尺寸<br>. Length，数据的长度</p>
</blockquote>
<p>当值写入Write Var[0x50]的时候，其实情况和Read Var的时候差不多。这里就不多赘述了，用wireshark一抓就知道了。</p>
<h2 id="5-小结"><a href="#5-小结" class="headerlink" title="5. 小结"></a>5. 小结</h2><p>对于整个S7协议簇在ISO七层网络架构里面的分类其实很简单了，格式如下：</p>
<table>
<thead>
<tr>
<th>Ethernet</th>
<th>Ip</th>
<th>TCP</th>
<th>TPKT</th>
<th>ISO-COTP</th>
<th>S7COMM</th>
</tr>
</thead>
</table>
<p>截图说明会更直观：<br><img src="/img/blog_page/3427087-20240413004638155-1196505560.png" srcset="/img/loading.gif" lazyload><br>我的S7协议简单分析就到这里就结束了，全当是个人学习和总结记录。本文讲的都是走马观花，往深了讲的话每一个参数和功能码类型都有很多的东西，这个时候就需要去看S7的手册和文档了。<br>我比较喜欢一个看法，对技术要有敬畏之心，每一门技术都是无数聪明的脑子共同呈现的结果，我们站在巨人的肩膀上，我们无时无刻不在追逐前人的步伐。<br>学无止境。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Proctocol-related/" class="category-chain-item">Proctocol related</a>
  
  
    <span>></span>
    
  <a href="/categories/Proctocol-related/Profinet/" class="category-chain-item">Profinet</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/S7/" class="print-no-link">#S7</a>
      
        <a href="/tags/PN/" class="print-no-link">#PN</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>通过wireshark简单了解S7协议</div>
      <div>http://example.com/2024/07/21/通过wireshark简单了解S7协议/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>xiao cuncun</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年7月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/07/21/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E5%9C%A8HMI%E4%B8%8A%E7%9A%84%E4%BD%BF%E7%94%A8/" title="多路复用在HMI上的使用">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">多路复用在HMI上的使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/07/21/PLC%E6%8A%A5%E8%AD%A6%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86/" title="PLC报警消息处理">
                        <span class="hidden-mobile">PLC报警消息处理</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      

    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
